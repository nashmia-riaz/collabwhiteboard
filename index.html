<html>
<script src="http://cdn.pubnub.com/pubnub.min.js"></script>
<h2>Number of doodlers: <span id="occupancy">0</span></h2>

<script type="text/javascript">
var channel = 'my-draw-demo';

 var PUBNUB_demo = PUBNUB.init({
    publish_key: 'pub-c-156a6d5f-22bd-4a13-848d-b5b4d4b36695',
    subscribe_key: 'sub-c-f762fb78-2724-11e4-a4df-02ee2ddab7fe'
  });
pubnub.subscribe({
    channel: channel,
    callback: drawFromStream


  	// Add presence
  	presence: function(m){if(m.occupancy > 1){
        document.getElementById('unit').textContent = 'doodlers';
      }
    document.getElementById('occupancy').textContent = m.occupancy;
  }
});
  function publish(data) {
    pubnub.publish({
      channel: channel,
      message: data
    });
</script>

<canvas id="drawCanvas" width="800" height="600"></canvas>

<script type="text/javascript">

var canvas = document.getElementById('drawCanvas');
var ctx = canvas.getContext('2d');

ctx.lineWidth = '3';

canvas.addEventListener('mousedown', startDraw, false);
canvas.addEventListener('mousemove', draw, false);
canvas.addEventListener('mouseup', endDraw, false);

// create a flag
var isActive = false;

// array to collect coordinates
var plots = [];

function draw(e) {
  if(!isActive) return;

  // cross-browser canvas coordinates
  var x = e.offsetX || e.layerX - canvas.offsetLeft;
  var y = e.offsetY || e.layerY - canvas.offsetTop;

  plots.push({x: x, y: y});

  drawOnCanvas([1,0,0],plots);
}
function drawOnCanvas(color, plots) {
  ctx.beginPath();
  ctx.moveTo(plots[0].x, plots[0].y);

  for(var i=1; i<plots.length; i++) {
    ctx.lineTo(plots[i].x, plots[i].y);
  }
  ctx.stroke();
}
function drawFromStream(message) {
    if(!message) return;        

    ctx.beginPath();
    drawOnCanvas(message.plots);
}
function startDraw(e) {
  isActive = true;
}

function endDraw(e) {
  isActive = false;
	 pubnub.publish({
	    channel: channel,
	    message: { 
	        plots: plots // your array goes here
	    } 
	});
  // empty the array
  plots = [];
} 


</script>
</html>
